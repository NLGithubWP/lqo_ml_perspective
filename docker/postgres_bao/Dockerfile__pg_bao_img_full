FROM postgres:12.5

ARG DEBIAN_FRONTEND=noninteractive

# Install dependencies in a single RUN to reduce layers and clean up APT cache
RUN apt-get update && apt-get install -y \
    ca-certificates \
    sudo \
    wget \
    curl \
    git \
    nano \
    libpq-dev \
    postgresql-server-dev-12 \
    build-essential \
    make \
    && rm -rf /var/lib/apt/lists/*

# Avoid reinstalling postgresql-12 and postgresql-client-12 (already in base image)
# Note: postgresql-server-dev-12 is kept for pg_hint_plan compilation

# Set password for 'postgres' Linux user securely (consider alternatives)
RUN echo "postgres:postgres" | chpasswd && \
    usermod -aG sudo postgres

# Install pg_hint_plan
WORKDIR /root
RUN git clone --depth 1 --branch REL12_1_3_7 https://github.com/ossc-db/pg_hint_plan.git && \
    cd pg_hint_plan && \
    make PG_CONFIG=/usr/lib/postgresql/12/bin/pg_config && \
    make PG_CONFIG=/usr/lib/postgresql/12/bin/pg_config install && \
    cd .. && rm -rf pg_hint_plan

# Reset working directory
WORKDIR /

# Optional: Set environment variables or entrypoint if needed